<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Account Access | Raelyboy</title>
  <link rel="stylesheet" href="/assets/public.css" />
</head>
<body>
  <div class="page">
    <header>
      <div class="container">
        <h1 class="brand">Account Access</h1>
      </div>
    </header>

    <main>
      <div class="container">
        <section class="card">
          <form id="login-form">
            <div class="form-row">
              <label for="login-username">Username or Email</label>
              <input id="login-username" name="username" autocomplete="username" required />
            </div>
            <div class="form-row">
              <label for="login-password">Password</label>
              <input id="login-password" name="password" type="password" autocomplete="current-password" required />
            </div>
            <div class="actions auth-actions">
              <button class="btn" type="submit">Sign In</button>
              <a class="btn secondary" href="/">Back</a>
            </div>
          </form>

          <form id="register-form" style="display:none;">
            <div class="form-row">
              <label for="register-username">Username</label>
              <input id="register-username" autocomplete="username" required />
            </div>
            <div class="form-row">
              <label for="register-password">Password</label>
              <input id="register-password" type="password" autocomplete="new-password" required minlength="8" />
            </div>
            <div class="form-row">
              <label for="register-name">Full Name</label>
              <input id="register-name" autocomplete="name" required />
            </div>
            <div class="form-row">
              <label for="register-email">Email</label>
              <input id="register-email" type="email" autocomplete="email" required />
            </div>
            <div class="form-row">
              <label for="register-phone">Phone</label>
              <input id="register-phone" type="tel" autocomplete="tel" required />
            </div>
            <div class="actions auth-actions">
              <button class="btn" type="submit">Create Account</button>
              <a class="btn secondary" href="/">Back</a>
            </div>
          </form>

          <p class="error" id="error" aria-live="polite"></p>
        </section>
      </div>
    </main>
  </div>

  <script>
    (function () {
      const params = new URLSearchParams(window.location.search);
      const next = params.get('next') || '/app';
      const requestedMode = params.get('mode') === 'register' ? 'register' : 'login';
      const loginForm = document.getElementById('login-form');
      const registerForm = document.getElementById('register-form');
      const error = document.getElementById('error');

      function setSession(user) {
        localStorage.setItem('budgetTrackerAuth', 'authenticated');
        localStorage.setItem('budgetTrackerUser', String(user.username || '').toLowerCase());
        localStorage.setItem('budgetTrackerUserId', String(user.id || '').trim());
      }

      if (localStorage.getItem('budgetTrackerAuth') === 'authenticated' && localStorage.getItem('budgetTrackerUserId')) {
        window.location.replace(next);
      }

      const isLogin = requestedMode === 'login';
      loginForm.style.display = isLogin ? 'block' : 'none';
      registerForm.style.display = isLogin ? 'none' : 'block';

      loginForm.addEventListener('submit', async function (event) {
        event.preventDefault();
        error.textContent = '';
        try {
          const response = await fetch('/api/auth-login', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              username: document.getElementById('login-username').value.trim(),
              password: document.getElementById('login-password').value,
            }),
          });
          const data = await response.json();
          if (!response.ok || !data?.user) throw new Error(data?.error || 'Unable to sign in.');
          setSession(data.user);
          window.location.replace(next);
        } catch (err) {
          error.textContent = err.message || 'Unable to sign in.';
        }
      });

      registerForm.addEventListener('submit', async function (event) {
        event.preventDefault();
        error.textContent = '';
        try {
          const response = await fetch('/api/auth-register', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              username: document.getElementById('register-username').value.trim(),
              password: document.getElementById('register-password').value,
              name: document.getElementById('register-name').value.trim(),
              email: document.getElementById('register-email').value.trim(),
              phone: document.getElementById('register-phone').value.trim(),
            }),
          });
          const data = await response.json();
          if (!response.ok || !data?.user) throw new Error(data?.error || 'Unable to create account.');
          setSession(data.user);
          window.location.replace(next);
        } catch (err) {
          error.textContent = err.message || 'Unable to create account.';
        }
      });
    })();
  </script>
</body>
</html>
